import requests
import time
from datetime import datetime, timedelta
import json

def main():
    check_app_status()
    # while True:   
    #     time.sleep(1)
    #     try:
    #         response = requests.request("GET", 'http://localhost:3000')
    #         print('RESPONSE STATUS CODE:',response.status_code)
    #     except:
    #         print('Crashed')


# check if app is online/offline
def check_app_status():
    print("CHECK APP STATUS")
    while True:
        # time.sleep(1)
        # setting sleep to 15 seconds should not cause downtime
        # time.sleep(5)
        # socketio.sleep(1)
        # count += 1
        timenow = datetime.now()
        
        try:
            response = requests.request("GET", 'http://localhost:3000')
            print('RESPONSE STATUS CODE:',response.status_code)
            if response.status_code == 200:
                auth_result, auth_token, basket_id = check_rest_user_login(timenow)
                basket_results = check_api_basketitems(auth_token,basket_id)
                checkout_results = check_rest_basket_checkout(auth_token, basket_id)
                user_count = check_user_registered(auth_token)
                # user_active = check_user_active()
                print('VARIABLES:',auth_result, basket_id,basket_results,checkout_results,user_count)
                # socketio.emit('my_response', {'app_status':'online', 'api_user_login':auth_result, 'basket_result':basket_results, 'checkout_results':checkout_results, 'user_count':user_count,'user_active':user_active,'startTime':str(timenow.isoformat()), 'endTime':str((timenow+timedelta(seconds=1)).isoformat()), 'title':'up'})
            else:
                print("SUM TING WONG")
                # socketio.emit('my_response', {'app_status':'offline', 'api_user_login':"failed", 'basket_result':"failed", 'checkout_results':"failed", 'user_count':0,'user_active':0,'startTime':str(timenow.isoformat()), 'endTime':str((timenow+timedelta(seconds=1)).isoformat()), 'title':'down'})
        except:
            print('SUM TING REALLLY WONG')
            # socketio.emit('my_response', {'app_status':'offline', 'api_user_login':"failed", 'basket_result':"failed", 'checkout_results':"failed", 'user_count':0, 'user_active':0,'startTime':str(timenow.isoformat()), 'endTime':str((timenow+timedelta(seconds=1)).isoformat()), 'title':'down'})

def create_app_user():
    # print("Trying request...")
    try:
        headers = {'Content-Type': "application/json"}
        payload = "{\"email\": \"test@securethebox.us\", \"password\": \"changemestb\"}"
        response = requests.request("POST", "http://localhost:3000/api/Users", data=payload,headers=headers)
        json_response = json.loads(response.json())
        print("json_response:",json_response)
    except:
        print("Failed user creation request or user")

def check_rest_user_login(timenow):
    # time.sleep(5)
    # print('CHECK REST USER LOGIN')
    try:
        payload = "{\"email\": \"test@securethebox.us\", \"password\": \"changemestb\"}"
        headers = {'Content-Type': "application/json"}
        response = requests.request("POST", "http://localhost:3000/rest/user/login", data=payload, headers=headers)
        json_response = json.loads(response.text)
        # print(json_response)
        if json_response['authentication']['umail'] == "test@securethebox.us":
            auth_result = "success"
            auth_token = json_response['authentication']['token']
            basket_id =  json_response['authentication']['bid']
            # print("AUTH_RESULT:",auth_result)
            # print("AUTH_TOKEN:",auth_token)
            # print("BASKET_ID:",basket_id)
            return auth_result, auth_token, basket_id
        else:
            print("SUM TING WONG - check_rest_user_login")
            create_app_user()
            auth_result = "failed"
            auth_token = "none"
            return auth_result, auth_token
    except:
        print("SUM TING WONG - check_rest_user_login")
        # create_app_user()
        # create_app_user()
        auth_result = "failed"
        auth_token = "none"
        return auth_result, auth_token

def check_api_basketitems(auth_token,basket_id):
    # time.sleep(5)
    # print('CHECK API BASKETITEMS')
    headers = {
        'content-type': "application/json",
        'Authorization': "Bearer "+auth_token,
        }
    if auth_token != "none":
        try:
            url = "http://localhost:3000/api/BasketItems"
            payload = "{ \"BasketId\": "+str(basket_id)+", \"ProductId\": 2, \"quantity\": 1 }"
            response = requests.request("POST", url, data=payload, headers=headers)
            json_response = json.loads(response.text)
            # print("ADD BASKET RESPONSE",response)
            if json_response['status'] == "success":
                # print("ADDED ITEM TO BASKET!")
                return "success"
            else:
                print("SUM TING WONG - check_api_basketitems")
                return "failed"
        except:
            print("SUM TING WONG - check_api_basketitems")
            return "failed"

def check_rest_basket_checkout(auth_token, basket_id):
    # time.sleep(5)
    # print('CHECK REST BASKET CHECKOUT')
    headers = {
        'content-type': "application/json",
        'Authorization': "Bearer "+auth_token,
        }
    if auth_token != "none":
        try:
            url = "http://localhost:3000/rest/basket/"+str(basket_id)+"/checkout"
            response = requests.request("POST", url, headers=headers)
            json_response = json.loads(response.text)
            # print("CHECKOUT BASKET RESPONSE",response)
            if 'orderConfirmation' in json_response:
                # print("BASKET CHECKOUT!")
                return "success"
            else:
                print("SUM TING WONG - check_rest_basket_checkout")
                return "failed"
        except:
            print("SUM TING WONG - check_rest_basket_checkout")
            return "failed"

def check_user_registered(auth_token):
    # time.sleep(5)
    # print('CHECK USER REGISTERED')
    headers = {
        'Authorization': "Bearer "+auth_token,
        }
    if auth_token != "none":
        try:
            url = "http://localhost:3000/api/Users"
            response = requests.request("GET", url, headers=headers)
            json_response = json.loads(response.text)
            if 'status' in json_response:
                user_count = len(json_response['data'])
                return int(user_count)
            else:
                print("SUM TING WONG - check_user_registered")
                return 0
        except:
            print("SUM TING WONG - check_user_registered")
            return 0



if __name__ == "__main__":
    main()